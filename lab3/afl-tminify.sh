#!/bin/bash

# Check if running as root
if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit # If not, bye
fi

# Assign desired locations to variables
#INPUT_FILES="/home/osboxes/jpeg/inputs/*"
INPUT_FILES="/home/osboxes/jpeg/external_inputs/*"
#INPUT_DIR="/home/osboxes/jpeg/inputs"
INPUT_DIR="/home/osboxes/jpeg/external_inputs"
#OUTPUT_DIR="/home/osboxes/jpeg/tmin_outputs"
OUTPUT_DIR="/home/osboxes/jpeg/tmin_external_outputs"
PROGRAM="/home/osboxes/jpeg/src/src/jpeg"
TEST_DIR="/home/osboxes/jpeg/tests"
c=0 # Counter variable

echo ""

# Checks for directories and files
if [ -f "$PROGRAM" ]; then
    echo "Program found!"
else
    echo "Couldn't locate program. Exiting ..."
    exit
fi

if [ -d "$INPUT_DIR" ]; then
    echo "Inputs directory found!"
else
    echo "Input directory NOT found. Exiting ..."
    exit
fi

if [ -d "$TEST_DIR" ]; then
    echo "Test file directory foudn!"
else   
    mkdir "$TEST_DIR"
    if [ -d "$TEST_DIR" ]; then
        echo "Test file directory successfully created"
    else
        echo "Couldn't create test file directory!. Fix it. Exiting ..."
        exit
    fi
fi

if [ -d "$OUTPUT_DIR" ]; then
    echo "Output directory exists ..."
else
    mkdir "$OUTPUT_DIR" # Creates output directory if it doesn't exist
    if [ -d "$OUTPUT_DIR" ]; then
        echo "Output directory created sucessfully!"
    else   
        echo "Couldn't create output directory. Exiting ..."
        exit
    fi
fi
# Done with checks

echo ""

# Loop through input file dir
for i in $INPUT_FILES
do
    let c++
    if test -f "$i" # Checks each thing in folder is a file
    then
        OUTPUT_FILE=$(basename -- "${i%.jpg}.min.jpg") #strips path and sticks min in front of jpg
        #echo "$OUTPUT_FILE" # Test what the files look like
        #echo "afl-tmin -i "$i" -o "$OUTPUT_DIR/$OUTPUT_FILE" -f test."$c".jpg "$PROGRAM" test."$c".jpg" # Test to see if output is desired
        afl-tmin -i "$i" -o "$OUTPUT_DIR/$OUTPUT_FILE" -f test."$c".jpg "$PROGRAM" test."$c".jpg # Run command on each input file

    fi
done # end loop

echo ""

# Cleanup
#rm -rf "$TEST_DIR"
#if [ -d "$TEST_DIR" ]; then
#    echo "Couldn't delete test file directory!"
#else   
#    echo "Cleanup completed successfully!"
#fi
#
#echo ""